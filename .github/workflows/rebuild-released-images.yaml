# Github workflow that rebuilds already released images

name: Daily build 
on:
  schedule:
    - cron: "0 1 * * 1-5"
    - cron: "0 3 * * 1-5"
  workflow_dispatch:
    inputs:
      image_repo:
        type: choice
        description: "Target image repository for built images"
        default: mongodb/mongodb-atlas-kubernetes-operator-prerelease
        required: true
        options:
        - mongodb/mongodb-atlas-kubernetes-operator-prerelease
        - mongodb/mongodb-atlas-kubernetes-operator

jobs:
  read-versions:
    name: Read config file 
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.images-matrix.outputs.matrix }}
      platforms: ${{ steps.images-matrix.outputs.platforms }}
      date: ${{ steps.set-date.outputs.date }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
      - name: Read config file (daily-builds.json) 
        id: images-matrix
        run: |
          CONTENT=`cat ./daily-builds.json`
          CONTENT="${CONTENT//'%'/'%25'}"
          echo matrix=${CONTENT} >> $GITHUB_OUTPUT
      - name: Set date
        id: set-date
        run: |
          DATE=$(date +'%Y-%m-%d')
          echo date=${DATE} >> $GITHUB_OUTPUT
  
  build-and-publish-image:
    runs-on: ubuntu-latest
    env:
      IMAGE_REPOSITORY:  ${{ github.event.inputs.image_repo || 'mongodb/mongodb-atlas-kubernetes-operator' }} 
    needs:
      - read-versions
    strategy:
      matrix:
        version: ${{ fromJSON(needs.read-versions.outputs.matrix).versions }}
    steps:
      - name: Print daily tag
        id: daily-tag
        run: |
          DAILY_TAG="${{ matrix.version }}-${{needs.read-versions.outputs.date}}"
          echo "daily-tag=${DAILY_TAG}" >> $GITHUB_OUTPUT
      - name: Rebuild ${{matrix.version}}
        run: |
          echo "Building ${{matrix.version}} version"
      - name: Build and push operator to Dockerhub & Quay (daily-tag)
        uses: ./.github/actions/build-push-image
        with:
          repository: ${{ env.IMAGE_REPOSITORY }}
          version: ${{ steps.daily-tag.outputs.daily-tag }}
          platforms: ${{ fromJSON(needs.read-versions.outputs.matrix).platforms }}
          ref: v${{ matrix.version }}
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_password: ${{ secrets.DOCKER_PASSWORD }}
          # push_to_quay: true
          # quay_username: mongodb+mongodb_atlas_kubernetes
          # quay_password: ${{ secrets.QUAY_PASSWORD }}
      - name: Build and push operator to Dockerhub & Quay (release-tag)
        uses: ./.github/actions/build-push-image
        with:
          repository: ${{ env.IMAGE_REPOSITORY }}
          version: ${{ matrix.version }}
          platforms: ${{ fromJSON(needs.read-versions.outputs.matrix).platforms }}
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_password: ${{ secrets.DOCKER_PASSWORD }}
          # push_to_quay: true
          # quay_username: mongodb+mongodb_atlas_kubernetes
          # quay_password: ${{ secrets.QUAY_PASSWORD }}
