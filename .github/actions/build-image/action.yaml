name: Build Container Image
description: Builds the operator container image for the given architecture
inputs:
  platforms:
    description: The list of platforms for which the image will be built
    required: true
  version:
    description: The version of the operator will be built
    required: true
  repository:
    description: The name of repository to build image
    required: true
  push_to_quay:
    description: Also push image to quay.io
    required: false
runs:
  using: "composite"
  steps:
    - name: Check out code
      uses: actions/checkout@v3.1.0
      with:
        submodules: true
        fetch-depth: 0
    - name: "Set up QEMU"
      uses: docker/setup-qemu-action@v2
      with:
        platforms: ${{ inputs.platform }}
    - name: "Set up Docker Buildx"
      uses: docker/setup-buildx-action@v2
      with:
        platforms: ${{ inputs.platform }}
    - name: Push Atlas Operator to Registry
      uses: docker/build-push-action@v3
      with:
        context: .
        build-args: VERSION=${{ inputs.version }}
        platforms: ${{ inputs.platform }}
        tags: ${{ inputs.repository }}:${{ inputs.version }}
        push: false
        outputs: type=docker,dest=/tmp/operator.tar
    - name: Login to docker registry
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    - name: Push Image to docker registry
      shell: bash
      run: |
        docker push ${{ inputs.repository }}:${{ inputs.version }}
    - name: Login to quay.io registry
      if: ${{ inputs.push_to_quay }}
      uses: docker/login-action@v2
      with:
        registry: quay.io
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    - name: Push Image to docker registry
      if: ${{ push_to_quay }}
      shell: bash
      run: |
        docker push quay.io/${{ inputs.repository }}:${{ inputs.version }}